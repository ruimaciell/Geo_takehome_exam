---
title: "How Do Various Factors Influence Urban Road Safety in Barcelona?"
output: html_document
date: "2024-03-21"
#bibliography: references.bib
---

Team members: Viktoriia Yuzkiv, Rui Maciel, Angelo Di Gianvito


## Introduction

Living in Barcelona, a city vibrant with life and movement, we are constantly navigating its streets, whether on foot, by bike, or in a vehicle. However, amidst its beauty and energy, Barcelona, like any other urban center, grapples with the challenge of road safety. The occurrence of car accidents, ranging from minor collisions to tragic fatalities, underscores the importance of understanding the dynamics of road incidents within the city.

Using geospatial data and approach, our research proposal has the goal of giving an overview of the accidents paradigm of Barcelona. We use data provided by the Guardia Civil, which locates precisely the location of accidents. Afterwards, using geospatial features of the urban life, such as location of crosswalks, traffic patterns we aim to contribute to the literature by identifying non-human behaviour causes to the existence of accidents. Our aim is then, with this findings, to improve the policy making in the urban life of Barcelona, with the ultimate goal of reducing injuries and the cost of human lives.

As residents of Barcelona, our team recognizes the necessity of exploring the spatial patterns and factors influencing car accidents. By delving into the distribution of accidents across different districts, examining the severity of injuries and fatalities, and scrutinizing temporal variations, we aim to unearth insights that can inform not only our personal vigilance but also contribute to broader discussions on urban safety measures.

With this context in mind, our research question emerges: What are the spatial and temporal determinants of car accidents in Barcelona? Through this inquiry, we seek to elucidate whether there are distinct patterns in accident occurrence and number of victims across districts, whether certain months exhibit higher rates, and whether there exists a correlation between accident frequency and proximity to essential infrastructures like crosswalks. By answering these questions, we endeavor to provide actionable insights for enhancing road safety strategies and fostering a more secure urban environment for all residents and visitors of Barcelona.

## Data

Our project uses data provided by the Ayuntamiento de Barcelona through its platform "Open Data BCN".


## Literature review

The integration of geospatial features into the study and prediction of road traffic accidents (RTAs) has marked a significant evolution in the field of urban planning and public safety. Through the examination of various research findings, it becomes evident that geospatial data is pivotal in uncovering the relations between urban environments and accident occurrences. 

The core of these studies lies in their innovative use of Geographic Information Systems (GIS) and spatial analysis techniques to map and analyze the distribution and determinants of RTAs across different urban settings. For instance, detailed spatial analyses conducted in cities like Barcelona, as discussed by Chaudhuri et al. (2023) , and Lisbon, analyzed by Mesquitela et al. (2022) , leveraged geospatial data to identify high-risk road segments and accident clusters. These studies effectively demonstrate how geospatial data can be utilized to provide detailed insights into the spatial patterns of traffic accidents, enabling the development of targeted safety measures.

Moreover, the spatial-temporal variability highlighted in the research, such as in the studies from Belgrade by Lović Obradović et al. (2022) and Bursa by Haybat et al. (2022) , emphasizes the dynamic nature of RTA risk factors. Geospatial features, when analyzed over time, reveal how accident hotspots evolve and how factors such as time of day, seasonality, and specific urban configurations contribute to the risk of accidents. These findings are crucial for implementing dynamic and responsive urban safety strategies that can adapt to changing urban landscapes and mobility patterns.

Additionally, the application of geospatial data extends beyond traditional analysis, as demonstrated by the use of machine learning models to predict RTA risks. Shi et al. (2021) incorporated geospatial features into machine learning models, offering a granular geospatial view of accident probabilities across urban road networks. This approach represents a forward leap in predictive analytics, providing a tool for preemptive safety planning and risk assessment at the road segment level.

In summary, by enabling the precise identification of high-risk areas and the factors contributing to accidents, geospatial analysis serves as a cornerstone for developing targeted, data-driven interventions. These advancements underscore the potential of geospatial data to revolutionize the way cities approach the challenge of reducing RTAs, ultimately contributing to safer and more resilient urban environments. 

Papers to cite (This is a draft. Papers that were cited will be added afterwards after this has been done. )



```{r include=FALSE}
## Clean the environment and set the working directory

# Clean the environment
rm(list = ls(all.names = TRUE))

# Set the working directory to the location of the Geospatial data
#setwd("/Users/ruimaciel/Desktop/Barcelona/Geospatial/Geo_takehome_exam")
setwd("/Users/viktoriia/Desktop/BSE/Term 2/Geospatial/Geo_takehome_exam")
```


```{r include=FALSE}
## Load necessary libraries
library(sf, quietly = TRUE)         # For handling spatial data
library(ggplot2, quietly = TRUE)    # For plotting
library(raster, quietly = TRUE)     # For creating raster data
library(terra, quietly = TRUE)      # For spatial data manipulation, similar to raster but more recent
library(dplyr, quietly = TRUE)      # For data manipulation
library(viridis, quietly = TRUE)    # For color palettes
library(gridExtra, quietly = TRUE)  # For plots arrangement
library(readr, quietly = TRUE)      # For read_csv
library(lubridate, quietly = TRUE)  # For date-time conversion
library(sandwich, quietly = TRUE)
library(lmtest, quietly = TRUE)
```


## Data

```{r }
# Load the data
districts_data <- read.csv('BarcelonaCiutat_Districtes.csv')
accidents_data <- read.csv('2023_accidents_gu_bcn (1).csv')

# Convert districts and accidents data to sf objects
districts_sf <- st_as_sf(districts_data, wkt = "geometria_wgs84", crs = 4326)
accidents_sf <- st_as_sf(accidents_data, coords = c("Longitud_WGS84", "Latitud_WGS84"), crs = 4326)

# Shape of the accidents df
dim(accidents_data)
```

In 2023, there were 7724 traffic accidents in the city. 

```{r }
# Remove observations with missing data (filter out -1 values from Codi_districte)
accidents_data <- accidents_data %>%
  filter(Codi_districte != -1)

head(accidents_data)
```

The dataset includes detailed information on car accidents, such as precise coordinates and metadata like geospatial characteristics (district, neighborhood, street) and time characteristics (month, day, hour). It also provides data on the number of victims categorized by severity (fatalities, serious injuries, minor injuries). This allows us to analyze the spatial and temporal distribution of accidents and understand the impact on human casualties.


## 1. Understanding the accident landscape

In this section, we delve into the data regarding the frequency and distribution of car accidents in Barcelona. Utilizing the heatmap and district-level map, we aim to visualize the concentration of incidents across the city, providing an overview of the accident landscape. This analysis offers valuable insights into how accidents are distributed across the city's different areas, shedding light on potential hotspots and areas of concern.


### Exploring the number of accidents

```{r }
# Aggregate the number of accidents by district
accidents_agg <- accidents_data %>%
  group_by(Codi_districte) %>%
  summarize(total_accidents = n())

# Merge the aggregated data with districts_sf
districts_sf_joined <- left_join(districts_sf, accidents_agg, by = c("codi_districte" = "Codi_districte"))

# Plot the data
ggplot() +
  geom_sf(data = districts_sf_joined, aes(fill = total_accidents), color = 'black') +  # Plot districts
  geom_sf_label(data = districts_sf_joined, aes(label = nom_districte), size = 3, label.padding = unit(0.25, "lines"), fontface = "bold") + # Add district names
  scale_fill_viridis(option = "viridis", discrete=FALSE, name = "Accident Count", labels = scales::comma) + 
  labs(title = "Total Number of Accidents by District in Barcelona") +
  theme_void() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
```

The map highlights Eixample as the district with the highest accident count in 2023, followed by Sant Martí, Sarrià-Sant Gervasi, and Sants-Montjuïc, each experiencing approximately 2.3 to 2.6 times fewer accidents. This emphasizes the need for targeted interventions and increased awareness in high-risk areas to improve overall road safety in Barcelona.

Additionally, plotting a heatmap instead of aggregating by district could offer further insights into the most frequent areas of accidents.

```{r }
# Define the extent based on the accidents data
ext <- st_bbox(accidents_sf)
r_extent <- raster::extent(ext$xmin, ext$xmax, ext$ymin, ext$ymax)

# Define resolution
res <- 0.002 # Adjust resolution based on your dataset

# Calculate the number of rows and columns based on the resolution
num_rows <- ceiling((ext$ymax - ext$ymin) / res)
num_cols <- ceiling((ext$xmax - ext$xmin) / res)

# Create an empty raster with defined extent and resolution
r <- raster::raster(nrows=num_rows, ncols=num_cols, xmn=ext$xmin, xmx=ext$xmax, ymn=ext$ymin, ymx=ext$ymax)

# Set the resolution of the raster
res(r) <- c(res, res)

# Rasterize the accidents data
accidents_raster <- rasterize(x=accidents_sf, y=r, field=1, fun='count', background=0)

# Convert the raster to a dataframe
accidents_df <- as.data.frame(accidents_raster, xy=TRUE)

# Replace NA with 0 if any NAs are present
if(any(is.na(accidents_df$value))) {
  accidents_df$value[is.na(accidents_df$value)] <- 0
}

# Proceed to plot the heatmap
ggplot() +
  geom_tile(data = accidents_df, aes(x = x, y = y, fill = layer)) +  # Heatmap of accidents
  geom_sf(data = districts_sf, fill = NA, color = "black", size = 0.2) +  # Boundaries of districts
  scale_fill_gradient(low = "white", high = "red", name = "Accident Count") +
  coord_sf(datum = NA) +  # Use coord_sf to align the plot with the sf data
  labs(title = "Heatmap of Accidents in Barcelona with District Boundaries") +
  theme_void() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
```

The heatmap notably reveals a higher concentration of accidents on major roads such as Av. Diagonal and Gran Via de les Corts Catalanes.


### Exploring accident severity

Given our primary concern for human life, it's crucial to assess whether there are any areas where accidents pose a greater threat to safety.

Columns we will check:
1. Numero_morts - the number of fatalities
2. Numero_lesionats_lleus - the number of minor injuries
3. Numero_lesionats_greus - the number of serious injuries
4. Numero_victimes - the total number of victims

```{r }
# Print the summary (total count) for each column
total_sum <- c(
  Numero_morts = sum(accidents_data$Numero_morts),
  Numero_lesionats_lleus = sum(accidents_data$Numero_lesionats_lleus),
  Numero_lesionats_greus = sum(accidents_data$Numero_lesionats_greus),
  Numero_victimes = sum(accidents_data$Numero_victimes)
)

# Print the total sum for each column
print(total_sum)
```

In 2023, a total of 8,708 individuals were involved in car accidents. Among them, 21 tragically lost their lives, while 227 sustained serious injuries. Fortunately, the majority of incidents resulted in minor injuries, with 8,460 individuals affected.


```{r }
# Filter the dataset (fatalities)
accidents_with_fatalities <- accidents_sf[accidents_sf$Numero_morts > 0, ]

# Create a plot using ggplot2
plot_fatalities <- ggplot() +
  geom_sf(data = districts_sf, fill = 'white', color = 'black') +  # Plot districts
  geom_sf(data = accidents_with_fatalities, color = 'red', size = 1.5, alpha = 1) + # Plot accidents
  theme_void() +
  labs(title = "Accidents with Fatalities") +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        plot.caption = element_text(size = 8, hjust = 0.5))


# Create a plot using ggplot2
accidents_with_serious_injuries <- accidents_sf[accidents_sf$Numero_lesionats_greus > 0, ]

# Plot the data using ggplot2
plot_serious_injuries <- ggplot() +
  geom_sf(data = districts_sf, fill = 'white', color = 'black') +  # Plot districts
  geom_sf(data = accidents_with_serious_injuries, color = 'red', size = 1.5, alpha = 0.7) + # Plot accidents
  theme_void() +
  labs(title = "Accidents with Serious Injuries") +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))


# Arrange plots side by side
grid.arrange(plot_fatalities, plot_serious_injuries, ncol = 2)
```

Surprisingly, despite Eixample having the highest number of accidents, the number of fatalities is lower than in some other districts. Regarding the serious injuries, it is evident that there are some hotspots in the Eixample destrict.


Given that the majority of accidents result in minor injuries, looking at the absolute number of accidents by areas will not give additional insights, but instead it would be useful to examine the areas with the lowest and highest rates of injuries per accident.

```{r }
# Calculate the total number of accidents by district
accidents_by_district <- accidents_data %>%
  group_by(Nom_districte, Codi_districte) %>%
  summarize(total_accidents = n())

# Calculate the total number of minor injuries by district
injuries_by_district <- accidents_data %>%
  group_by(Nom_districte) %>%
  summarize(total_minor_injuries = sum(Numero_lesionats_lleus, na.rm = TRUE))

# Merge the two datasets by district code
injuries_rate_by_district <- merge(accidents_by_district, injuries_by_district, by = "Nom_districte")

# Calculate the rate of injuries per accident by district
injuries_rate_by_district$injuries_per_accident <- injuries_rate_by_district$total_minor_injuries / injuries_rate_by_district$total_accidents

# Sort the data by injuries_per_accident in descending order
injuries_rate_by_district <- injuries_rate_by_district %>%
  arrange(desc(injuries_per_accident))

# Merge the aggregated data with districts_sf
districts_sf_injuries <- left_join(districts_sf, injuries_rate_by_district, by = c("codi_districte" = "Codi_districte"))

# Plot the data
ggplot() +
  geom_sf(data = districts_sf_injuries, aes(fill = injuries_per_accident), color = 'black') +  # Plot districts
  geom_sf_label(data = districts_sf_joined, aes(label = nom_districte), size = 3, label.padding = unit(0.25, "lines"), fontface = "bold") + # Add district names
  scale_fill_viridis(option = "viridis", discrete=FALSE, name = "Injuries per Accident", labels = scales::comma) + 
  labs(title = "Minor Injuries Rate by District") +
  theme_void() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
```

Interestingly, the Nou Barris district has one of the lowest numbers of accidents, yet simultaneously records the highest level of injuries per accident. Similarly, Sant Marti had a comparatively low number of accidents, but the number of injuries per accident is high. Here, Eixample is in third place for the number of minor injuries per accident.


## 2. Identifying contributing factors

This section focuses on potential factors contributing to the rise in the number of accidents and victims in Barcelona. We investigate seasonal variations in accident rates, examine the proximity of accidents to crosswalks, and assess the influence of traffic levels on incident occurrence.


### Unveiling seasonal trends

Delving into temporal patterns, we explore how the occurrence of accidents fluctuates throughout the day and across different months.

#### Time of the day

```{r }
# Number of accidents by hour
accidents_data %>%
  group_by(Hora_dia) %>%
  summarize(total_accidents = n()) %>%
  arrange(desc(total_accidents))
```


```{r }
# Aggregate the number of accidents by district and hour of the day
accidents_agg <- accidents_data %>%
  group_by(Codi_districte, Hora_dia) %>%
  summarize(total_accidents = n())

# Merge the aggregated data with districts_sf
districts_sf_joined <- left_join(districts_sf, accidents_agg, by = c("codi_districte" = "Codi_districte"))

# Plot the data
ggplot() +
  geom_sf(data = districts_sf_joined, aes(fill = total_accidents), color = 'black') +  # Plot districts
  scale_fill_viridis(option = "viridis", discrete=FALSE, name = "Accident Count", labels = scales::comma) + 
  labs(title = "Total Number of Accidents by District and Hour in Barcelona") +
  theme_void() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  facet_wrap(~Hora_dia, ncol = 6) # Facet plot by hour of the day
```

```{r }
# Aggregate the number of accidents by district name and hour of the day
accidents_agg_names <- accidents_data %>%
  group_by(Nom_districte, Hora_dia) %>%
  summarize(total_accidents = n())

# Plot the line plot for number of accidents by hour
ggplot(accidents_agg_names, aes(x = Hora_dia, y = total_accidents, color = factor(Nom_districte))) +
  geom_line() +
  scale_color_viridis_d() + # Apply viridis color scheme
  labs(title = "Number of Accidents by Hour of the Day",
       x = "Hour of the Day",
       y = "Number of Accidents",
       color = "District") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
```

As expected, the number of accidents decreases during the night. Notably, in Eixample, the number of accidents during the night is much lower than during the day and is comparable to the levels in other districts. Interestingly, in Eixample, the number of accidents decreases at 15:00 and then rises again, reaching its peak at 18:00. The highest number of accidents in 2023 occurred at 14:00. It turns out that, generally, there are fewer accidents at 15:00 compared to the hours immediately before and after it.

#### Month

```{r }
# Number of accidents by month
accidents_data %>%
  group_by(Mes_any) %>%
  summarize(total_accidents = n()) %>%
  arrange(desc(total_accidents))
```


```{r }
# Aggregate the number of accidents by district and hour of the day
accidents_agg_month <- accidents_data %>%
  group_by(Codi_districte, Mes_any) %>%
  summarize(total_accidents = n())

# Merge the aggregated data with districts_sf
districts_sf_joined_month <- left_join(districts_sf, accidents_agg_month, by = c("codi_districte" = "Codi_districte"))

# Plot the data
ggplot() +
  geom_sf(data = districts_sf_joined_month, aes(fill = total_accidents), color = 'black') +  # Plot districts
  scale_fill_viridis(option = "viridis", discrete=FALSE, name = "Accident Count", labels = scales::comma) + 
  labs(title = "Total Number of Accidents by District and Month in Barcelona") +
  theme_void() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  facet_wrap(~Mes_any, ncol = 4) # Facet plot by hour of the day
```

```{r }
# Aggregate the number of accidents by district name and hour of the day
accidents_agg_names_month <- accidents_data %>%
  group_by(Nom_districte, Mes_any) %>%
  summarize(total_accidents = n())

# Plot the line plot for number of accidents by hour
ggplot(accidents_agg_names_month, aes(x = Mes_any, y = total_accidents, color = factor(Nom_districte))) +
  geom_line() +
  scale_color_viridis_d() + # Apply viridis color scheme
  labs(title = "Number of Accidents by Month",
       x = "Month",
       y = "Number of Accidents",
       color = "District") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
```

In general, it's observed that the summer months consistently record the highest number of accidents. Moreover, when analyzing the data across various districts, the monthly trends in accident occurrences appear to follow a similar pattern.


### Proximity to crosswalks

By analyzing the distance between accident locations and nearby crosswalks, we aim to uncover any correlations between accident frequency and the presence of pedestrian infrastructure.

```{r }
# Load crosswalks data
crosswalks_data <- read.csv('Infraestructures_Inventari_Pas_Vianants.csv')

# Filter out records where Data_Alta is greater than January 1, 2024 and Data_Baixa is smaller than January 1, 2023 so that we keep the crosswalks that were active in 2023
crosswalks_data <- crosswalks_data %>%
  filter(Data_Alta < as.Date("2024-01-01")) %>%
  filter(Data_Baixa == "" | Data_Baixa >= as.Date("2023-01-01"))

crosswalks_sf <- st_as_sf(crosswalks_data, coords = c("Longitud", "Latitud"), crs = 4326)

# Calculate distances between each accident point and all crosswalk points
distances <- st_distance(accidents_sf, crosswalks_sf)

# Find the minimum distance for each accident point
min_distances <- apply(distances, 1, min)

# Add the minimum distances to the accidents_sf dataset
accidents_sf$closest_crosswalk_distance <- min_distances

# Remove outliers from the closest_crosswalk_distance column:
# Calculate the first and third quartiles
q1 <- quantile(accidents_sf$closest_crosswalk_distance, 0.25)
q3 <- quantile(accidents_sf$closest_crosswalk_distance, 0.75)

# Calculate the interquartile range (IQR)
iqr <- q3 - q1

# Define the lower and upper bounds for outliers
lower_bound <- q1 - 1.5 * iqr
upper_bound <- q3 + 1.5 * iqr

# Remove outliers
accidents_sf_trimmed <- subset(accidents_sf, closest_crosswalk_distance >= lower_bound & closest_crosswalk_distance <= upper_bound)
```


Now, let's check for a potential relationship between the number of accidents and the average closest distance to crosswalks at the neighborhood level. We are utilizing neighborhoods instead of districts here for a lower granularity level, thereby yielding more precise results.

```{r }
# Group data by Codi_barri and calculate count of accidents and average closest_crosswalk_distance
grouped_data <- accidents_sf_trimmed %>%
  group_by(Codi_barri) %>%
  summarize(total_accidents = n(),
            avg_distance = mean(closest_crosswalk_distance, na.rm = TRUE))

# Run linear regression
linear_model <- lm(total_accidents ~ avg_distance, data = grouped_data)

# Add regression line to the scatter plot
scatter_with_regression <- ggplot(grouped_data, aes(x = avg_distance, y = total_accidents)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add linear regression line
  labs(title = "Total Accidents vs. Closest Crosswalk Distance",
       x = "Average Closest Crosswalk Distance",
       y = "Total Accidents") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))

# Print the scatter plot with regression line
print(scatter_with_regression)

# Print summary of linear regression
summary(linear_model)
```

Based on the results of the linear regression above, the coefficient for avg_distance is negative (-2.812), indicating that, on average, as the average distance to the closest crosswalk increases, the number of accidents in the neighborhood decreases (significant at the 5% significance level). This suggests that, according to the model, areas closer crosswalks tend to have more car accidents. However, it's essential to interpret this result with caution and remember that factors such as road conditions, traffic flow, visibility, and driver behavior may also play significant roles in accident occurrence.


### Impact of traffic levels

We investigate the relationship between traffic volumes and the likelihood of accidents, examining how congestion levels may contribute to road safety challenges. Due to the large size of the traffic data and computational constraints, we utilize traffic data for January 2023 only.


```{r }
#Load roads map as it will be our bas
streets_data <- read.csv('transit_relacio_trams.csv')

# Parse 'coordenades' into a list of numeric vectors
streets_data$coordenades_parsed <- lapply(streets_data$Coordenades, function(coord_str) {
  # Split the string into individual numbers
  coord_parts <- unlist(strsplit(coord_str, ","))
  # Convert the character vector to a numeric matrix (2 columns for longitude and latitude)
  matrix(as.numeric(coord_parts), ncol = 2, byrow = TRUE)
})

# Create LineString geometries
streets_data$geometry <- lapply(streets_data$coordenades_parsed, function(coords) {
  st_linestring(coords)
})

streets_data_sf <- st_sf(streets_data, geometry = st_sfc(streets_data$geometry, crs = 4326))

# Perform spatial intersection to retain only streets within the city limits
streets_within_city_limits <- st_intersection(streets_data_sf, st_union(districts_sf))

# Load the traffic dataset into a dataframe
traffic_flow <- read_csv("Traffic/2023_01_Gener_TRAMS_TRAMS.csv", show_col_types = FALSE)

# Convert the data column to character for datetime parsing
traffic_flow$data <- as.character(traffic_flow$data)

# Attempt to parse each date-time, substituting NA for failures
traffic_flow <- traffic_flow %>%
  mutate(data_parsed = case_when(
    !is.na(data) ~ ymd_hms(data, quiet = TRUE),
    TRUE ~ as.POSIXct(NA)
  ))

# Plot average traffic state in January 2023
traffic_january <- traffic_flow %>%
  group_by(idTram) %>%
  summarise(average_state = mean(estatActual, na.rm = TRUE), .groups = 'drop')

# Assuming you have an sf object with street segments called street_segments_sf and it has a column named idTram
# Merge the traffic data with the street segments data
streets_data_traffic <- merge(streets_within_city_limits, traffic_january, by.x = "Tram", by.y = "idTram")

ggplot(data = streets_data_traffic) +
  geom_sf(aes(color = average_state)) +
  scale_color_gradient(low = "lightblue", high = "darkred") + # Custom color scale
  theme_minimal() +
  labs(title = "Traffic Intensity Map", 
       color = "Average Traffic State") +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
```


```{r}
# Filter the dataframe where 'nom_mes' equals 1
january_accidents <- accidents_sf %>%
  filter(Nom_mes == "Gener")

# Spatial Join
accidents_with_streets <- st_join(january_accidents, streets_within_city_limits, join = st_nearest_feature)

# Count the number of accidents for each 'Tram' (street segment)
accidents_count_per_tram <- accidents_with_streets %>%
  group_by(Tram) %>%
  summarise(accident_count = n(), .groups = 'drop')

# Convert 'accidents_count_per_tram' to a data frame if it's an sf object
accidents_count_per_tram_df <- as.data.frame(accidents_count_per_tram)

# Temporarily convert 'streets_within_city_limits' to a data frame if it's an sf object
streets_df <- as.data.frame(streets_within_city_limits)

# Perform the left join
accidents_count_per_street_df <- left_join(streets_df, accidents_count_per_tram_df, by = "Tram")

# Replace NA in accident_count with 0
accidents_count_per_street_df$accident_count[is.na(accidents_count_per_street_df$accident_count)] <- 0

accidents_with_traffic_per_street <- accidents_count_per_street_df %>%
  left_join(traffic_january, by = c("Tram" = "idTram"))


# Convert back to sf using the original geometry from 'streets_within_city_limits'
  accidents_count_per_street <- st_as_sf(accidents_count_per_street_df, geometry = st_geometry(streets_within_city_limits), crs = st_crs(streets_within_city_limits))

# Run the linear regression
model <- lm(accident_count ~ average_state, data = accidents_with_traffic_per_street)

# Assuming 'model' is your lm model object
robust_se <- sqrt(diag(vcovHC(model, type = "HC1")))

# Add accident_count to the fitted_values dataframe
fitted_values <- data.frame(
  average_state = accidents_with_traffic_per_street$average_state,
  accident_count = accidents_with_traffic_per_street$accident_count,
  fitted = fitted(model),
  lower = fitted(model) - 1.96 * robust_se,
  upper = fitted(model) + 1.96 * robust_se
)

coeftest_results <- coeftest(model, vcov = vcovHC(model, type = "HC1"))

# Print the results object
print(coeftest_results)

# Create the plot
ggplot(fitted_values, aes(x = average_state, y = accident_count)) +
  geom_point() + # Plot the data points using the fitted_values dataframe
  geom_line(aes(y = fitted), color = "blue") + # Add the regression line
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, fill = "blue") +
  theme_minimal() # A minimal theme for a cleaner look
```

Based on the model and chart presented above, we can say that in Barcelona, at the 1% significance level there exists evidence that increased traffic levels are associated with a higher number of accidents.


## 3. Regression Analysis: Predicting Victim Numbers

In this section, we employ linear regression analysis to identify variables that may influence the number of victims involved in car accidents. By considering factors explored in the previous sections as predictor variables, we aim to discern patterns and relationships that can inform strategies for mitigating accident severity and reducing human casualties.

```{r}
# Summarize the data by each 'Tram' (street segment)
accidents_count_per_tram <- accidents_with_streets %>%
  group_by(Tram, Nom_districte, Mes_any, Hora_dia) %>%
  summarise(victims_number = sum(Numero_victimes, na.rm = TRUE),
          accident_count = n(),
          avg_closest_distance = mean(closest_crosswalk_distance, na.rm = TRUE),
          .groups = 'drop')

# Convert 'accidents_count_per_tram' to a data frame if it's an sf object
accidents_count_per_tram_df <- as.data.frame(accidents_count_per_tram)

# Temporarily convert 'streets_within_city_limits' to a data frame if it's an sf object
streets_df <- as.data.frame(streets_within_city_limits)

# Perform the left join
accidents_count_per_street_df <- left_join(accidents_count_per_tram_df, streets_df , by = "Tram")

# Replace NA in accident_count with 0
#accidents_count_per_street_df$accident_count[is.na(accidents_count_per_street_df$accident_count)] <- 0

accidents_with_traffic_per_street <- accidents_count_per_street_df %>%
  left_join(traffic_january, by = c("Tram" = "idTram"))

# Run the linear regression
model <- lm(victims_number ~ Nom_districte + Hora_dia + avg_closest_distance + average_state, data = accidents_with_traffic_per_street)
summary(model)
```


The linear regression model indicates that the total number of victims (Y) is influenced by several factors. Here's a summary interpretation:

- Nom_districte (Districts): The coefficients for different districts indicate the change in the number of victims compared to a reference district. For instance, a coefficient of -0.17 for "Les Corts" district suggests that, on average, there are approximately -0.17 fewer victims in this district compared to the reference district when other variables are held constant. However, district coefficients are not statistically significant (p > 0.05), indicating that district alone might not be a strong predictor of the number of victims.

- Hora_dia (Hour of the day): The coefficient of 0.0176 suggests that for every one-unit increase in the hour of the day, there is an increase of approximately 0.018 victims, holding other variables constant. This coefficient is statistically significant (p = 0.01974), indicating that the time of day has a modest effect on the number of victims.

- avg_closest_distance: The coefficient of 0.0005346 suggests that for every one-unit increase in the distance to the closest crosswalks, there is an increase of approximately 0.000535 victims, holding other variables constant. This coefficient is statistically significant (p = 0.02820), indicating that higher distance from crosswalks might contribute to a slightly higher number of victims.

- average_state: The coefficient of 0.0416 suggests that for every one-unit increase in the traffic level, there is an increase of approximately 0.042 victims, holding other variables constant. However, this coefficient is not statistically significant (p = 0.45804), indicating that the average state might not be a significant predictor of the number of victims in this model.


Overall, the model has a low adjusted R-squared value of 0.01632, suggesting that the predictors included in the model explain only a small portion of the variance in the total number of victims. Further exploration and refinement of the model may be necessary to better understand the factors influencing the total number of victims in accidents.


## Conclusions

Our research journey through Barcelona's road safety landscape has shed light on crucial insights that can inform policy-making and urban planning attempts.Through the analysis of geospatial data, we identified spatial and temporal determinants of car accidents, offering actionable insights for enhancing road safety strategies.

The spatial distribution of accidents, highlighted through maps and heatmaps, revealed hotspots and high-risk areas, emphasizing the need for targeted interventions. Surprisingly, districts with the highest accident counts did not necessarily exhibit the highest fatality rates, indicating the importance of complex approaches to address different injury severities.

Temporal trends unveiled a relationship between accident occurrence and various factors such as time of day and month, underscoring the importance of temporal considerations in road safety planning. The regression analysis further elucidated the impact of factors like proximity to crosswalks and traffic levels on accident occurrence, providing evidence-based guidance for interventions.

While the regression model offered insights into the predictors of the total number of victims, its modest explanatory power suggests the presence of unaccounted factors influencing road safety outcomes. Thus, ongoing research efforts and data-driven initiatives are essential to refine models and develop holistic strategies for fostering a safer urban environment in Barcelona and beyond.

In essence, our findings underscore the significance of interdisciplinary collaborations, data-driven decision-making, and community engagement in mitigating road safety challenges and realizing our collective vision of safer streets for all.
